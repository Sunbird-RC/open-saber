<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link type="text/css" href="./css/profile.css" rel="stylesheet" />
    <link type="text/css" href="./css/signIn.css" rel="stylesheet" />

</head>

<body onload="myFunction()">
    <div id="navbar"> </div>
    <h3 class="text-center mt-2 mb-3">Profile Information</h3>
    <div class="border">
        <div class="image mb-2">
            <img src="http://icons.iconarchive.com/icons/graphicloads/flat-finance/256/person-icon.png" class="center mt-3"
                alt="Avatar">
        </div>
        <table id="row">
            <tbody>

            </tbody>
        </table>
        <div class="text-center pt-3">
            <span class=""><button class="btn btn-primary" id="button" onclick="edit(this.id)" style="margin-top: 1rem;" >Edit</button></span>
            <span class="pl-3 pr-3"><button class="btn btn-primary outline" id="button1" 
                    onclick="backtoProfile(this.id)">Cancel</button></span>
            <span class=""><button class="btn btn-primary" id="downButton" onclick="downloadJson()" data-toggle="tooltip"
                    title="Download Signed
                Profile">Download</button></span>
            <a id="downloadAnchorElem" style="display:none"></a>

        </div>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
        <script type="text/javascript">
          var query = window.location.search.substring(1);
                var qs = query.split('=');
            var tempobj;
            var readobj = [];
            var c = [];
            var admin;
            var checkVerification;
            var permanantObj;
            var tempkey;
            $(document).ready(function () {
                $('#navbar').load("bootstrap-4-navbar.html", function() {
                // console.log('nav item')
             document.getElementById("nav1").style.display = "none"
             document.getElementById("nav2").style.display = "none"
            
            });
                $('[data-toggle="tooltip"]').tooltip();
            
            });
            function myFunction() {
                searchVerificationDetails();
                readAdminStatus(qs);
                function searchVerificationDetails() {

                    const reqParam = {

                        "id": "open-saber.registry.search",
                        "ver": "1.0",
                        "ets": "11234",
                        "params": {
                            "did": "",
                            "key": "",
                            "msgid": ""
                        },
                        "request": {
                            "entityType": ["PersonVerified"],

                            "filters": {
                                "personId": { "contains": qs[1] }
                            }
                        }
                    }
                    const https = new XMLHttpRequest()
                    https.open('POST', "http://localhost:8080/search")
                    https.setRequestHeader('Content-type', 'application/json')
                    https.send(JSON.stringify(reqParam)) // Make sure to stringify

                    https.onload = function () {
                        checkVerification = JSON.parse(https.responseText);

                        checkVerification = checkVerification.result.PersonVerified[0];
                        // console.log(checkVerification)
                    }
                }

                const params = {
                    "id": "open-saber.registry.search",
                    "ver": "1.0",
                    "ets": "11234",
                    "params": {
                        "did": "",
                        "key": "",
                        "msgid": ""
                    },
                    "request": {
                        "entityType": ["Person"],

                        "filters": {
                            "osid": { "eq": qs[1].slice(2, qs[1].length) }
                        },
                        "viewTemplateId": "Person_Default.json"
                    }
                }

                const http = new XMLHttpRequest()
                http.open('POST', "http://localhost:8080/search")
                http.setRequestHeader('Content-type', 'application/json')
                http.send(JSON.stringify(params)) // Make sure to stringify
                var row = "", col = "";
                http.onload = function () {
                    var obj = JSON.parse(http.responseText);
                    // console.log(obj, admin)
                    document.getElementById('dropdown').innerHTML = obj.result.Person.name;
                    if(obj.result.Person.isAdmin) {
                        document.getElementById('admin').style.display = 'inline'
                        document.getElementById('adminline').style.display = 'inline'
                        document.getElementById('admin').href='./adminpage.html?name='+ obj.result.Person.name

                    }
                    for (key in obj) {
                        if (key === "result") {
                            readobj = obj[key].Person[0];
                            c = obj[key].Person[0];
                            for (var head in c) {
                                document.getElementById('button1').style.display = 'none';
                                if (admin === 'true') {
                                    document.getElementById('button').style.display  = 'none';
                                    document.getElementById("downButton").style.display = 'none'

                                }
                                var val = head;
                                var headval = head;
                                var value = c[head];
                                var temprow;
                                // console.log('val',)
                                temprow = "<tr><th class='header pr-5'>" + head.charAt(0).toUpperCase() + head.slice(1) + "</th><td id=" + head + " class='text' name=" + head + "  width='20% !importent'>" + value + "</td >";
                                person = head + 'Verified';
                                personobj = person.replace(/['"]+/g, '');

                                if (admin !== 'true') {
                                    if (checkVerification.hasOwnProperty(personobj) && checkVerification[head + 'Verified']) {
                                        var verifiedrow = "<td class='text pl-2' style='color:green;font-size: 14px;'><i class='fa fa-check-circle pr-1' style='color:green;font-size: small !important;'></i>validated</td></tr>";
                                        row += temprow + verifiedrow;
                                    }
                                    else {
                                        var validaterow = "<td class='text pl-2' style='color:#007bff;font-size: 14px;'><i class='fa fa-exclamation-circle pr-1' style='color: #007bff;font-size: small !important;'></i>Pending validation</td></tr>";
                                        row += temprow + validaterow;
                                    }
                                } else {
                                    var approvedrow = "<td class='text pl-2' id='style'><button  class='btn btn-outline-success mr-3 sc' style='color:green;font-size:1rem;' ><i class='fa fa-check-circle pr-1' style='color:green;font-size: small !important;'></i>approve</button><button class='btn btn-outline-danger sc' style='font-size:1rem;'>&nbsp;reject</button></td></tr>";
                                    row += temprow + approvedrow;
                                }

                            }
                            // $("table tbody tr th td").tooltipOnOverflow();
                            $("table tbody").append(row);

                            var element = document.getElementsByTagName("tr");
                            // console.log(element)
                            for (var i = 0; i < element.length; i++) {
                                var newElement = document.createElement('div');
                                var divElement = document.getElementsByTagName('div');
                                newElement.setAttribute('class', 'mt-2')
                                // console.log()
                                for (var j = 1; j < element.length - 1; j++) {
                                    // divElement[j+3].setAttribute('class', 'note');
                                    // console.log(divElement[j + 3]);
                                    name1 = "mystyle";
                                }
                                var elementParent = element[i].parentNode;
                                elementParent.insertBefore(newElement, element[i].nextSibling);
                            }

                        }
                    }
                }

            }
            function edit(id) {
                var isedited = false;
                var temp;
                var edit = document.getElementById(id);
                edit.innerHTML = "Update";
                document.getElementById('button1').style.display = '-webkit-inline-box';
                for (key in c) {
                    console.log(key, document.getElementById(key),c,permanantObj);
                    if (document.getElementById(key).firstChild != "[object HTMLInputElement]") {

                        var content = document.getElementById(key).firstChild.nodeValue;
                        console.log(content)
                        edit(key);
                        function edit(key) {
                            console.log(key);
                            var keys = key;
                            var anchor = document.getElementById(key);
                            var att = document.createAttribute("contenteditable");
                            att.value = "true";
                            anchor.setAttributeNode(att);
                            onchange(keys, key);
                        }
                        function onchange(keys, key) {
                            var childElemnet = document.getElementById(key);
                            console.log(childElemnet)
                            document.getElementById(key).onkeyup = function myFunction() {
                                var x = document.getElementById(key);
                                console.log(key,x);
                                //  tempkey = key.charAt(0).toLowerCase() + key.slice(1);
                                tempkey = key;
                                console.log(x.innerHTML, permanantObj[tempkey],tempkey,permanantObj)
                                if (x.innerHTML.localeCompare(permanantObj[tempkey])) {
                                    console.log('edited')
                                    isedited = true;
                                }
                                if (isedited) {
                                    permanantObj[tempkey] = x.innerHTML;
                                    update(isedited,qs[1]);
                                }
                            }
                        }
                        function update(edited,id) {
                            if (edited) {
                                const params = {
                                    "id": "open-saber.registry.update",
                                    "ver": "1.0",
                                    "ets": "11234",
                                    "params": {
                                        "did": "",
                                        "key": "",
                                        "msgid": ""
                                    },
                                    "request": {
                                        "Person": {
                                            "osid": qs[1],
                                        }
                                    }
                                }
                              
                                params.request.Person = permanantObj;
                                const http = new XMLHttpRequest()
                                http.open('POST', "http://localhost:8080/update")
                                http.setRequestHeader('Content-type', 'application/json')
                                http.send(JSON.stringify(params)) // Make sure to stringify

                                http.onload = function () {
                                 
                                    var obj = JSON.parse(http.responseText);
                                    console.log('obj',obj,params)
                                }
                            }
                        }
                    }
                }
            }
            function backtoProfile(id) {
                var keyValue = document.getElementById(id).value;
                window.location.href = window.location.href;
            }
            function downloadJson() {
                var urlParams = new URLSearchParams(location.search);
                const params = {
                    "id": "open-saber.registry.read",
                    "ver": "1.0",
                    "ets": "11234",
                    "params": {
                        "did": "",
                        "key": "",
                        "msgid": ""
                    },
                    "request": {
                        "Person": {
                            "osid": urlParams.get('osid'),
                            "includeSignatures": true
                        }
                    }
                }
                $.ajax({
                    url: "http://localhost:8080/read",
                    type: "post",
                    dataType: "application/json",
                    data: JSON.stringify(params),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (msg) {
                        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(msg.result.Person));
                        var dlAnchorElem = document.getElementById('downloadAnchorElem');
                        dlAnchorElem.setAttribute("href", dataStr);
                        dlAnchorElem.setAttribute("download", "Person.json");
                        dlAnchorElem.click();
                    }
                });
            }
            function readAdminStatus(osid) {
                const params = {
                    "id": "open-saber.registry.read",
                    "ver": "1.0",
                    "ets": "11234",
                    "params": {
                        "did": "",
                        "key": "",
                        "msgid": ""
                    },
                    "request": {
                        "Person": {
                            "osid": osid[1],
                            "includeSignatures": true
                        }
                    }
                }
                $.ajax({
                    url: "http://localhost:8080/read",
                    type: "post",
                    dataType: "application/json",
                    data: JSON.stringify(params),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (msg) {
                        
                        permanantObj = msg.result.Person;
                        console.log(permanantObj);
                       
                    }
                });
            }
        </script>
</body>

</html>